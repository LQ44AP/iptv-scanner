name: Build and Release Multi-Arch IPK

on:
  push:
    # 只有当推送的标签（tags）匹配 v* 时才运行
    tags:
      - 'v*'
  # 保留手动触发，方便调试
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86/64
          - arch: mipsel_24kc
            target: ramips/mt7621
          - arch: mips_24kc
            target: ath79/generic
          - arch: aarch64_generic
            target: rockchip/armv8
          - arch: arm_cortex-a15_neon-vfpv4
            target: bcm53xx/generic

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Build IPK
        uses: immortalwrt/gh-action-sdk@master
        with:
          architecture: ${{ matrix.target }}
          version: 23.05.5
          pkg_name: iptv-scanner
          
      - name: Organize Artifacts
        run: |
          mkdir -p ./bin_out
          # 查找生成的 ipk 并根据架构重命名，防止文件名冲突
          find bin/packages/ -name "iptv-scanner*.ipk" -exec cp {} ./bin_out/ \;

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          # 此处自动获取当前的 tag 名
          files: ./bin_out/*.ipk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
